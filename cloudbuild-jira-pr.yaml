# DO NOT EDIT THIS FILE it's managed in github.com/karhoo/terraform-modules
availableSecrets:
  secretManager:
    - versionName: projects/karhoo-scratch/secrets/GITHUB_TOKEN/versions/latest
      env: GH_TOKEN

options:
  logging: CLOUD_LOGGING_ONLY
  dynamic_substitutions: true
  env:
    - jira_regex=[a-zA-Z0-9,\.\_\-]+-[0-9]+

steps:
  - id: check_jira
    entrypoint: /bin/bash
    secretEnv: ["GH_TOKEN"]
    name: eu.gcr.io/karhoo-common/karhoo-jira-check:1.0.0
    args:
      - -c
      - |
        title=$(gh pr view $_PR_NUMBER --json title -q '.title' | grep -o -E "$jira_regex")
        if [ -z "$title" ]; then
          echo 'No JIRA ticket is provided in the title!!'
          echo "Expected regex: $jira_regex"
          exit 1
        else
          echo "Using ticket: $title"
        fi
